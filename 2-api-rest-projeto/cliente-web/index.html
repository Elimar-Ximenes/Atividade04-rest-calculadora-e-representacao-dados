<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Cliente Web ‚Äì Pa√≠ses</title>

<!-- Bootstrap -->
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">

<script src="https://cdn.jsdelivr.net/npm/protobufjs/dist/protobuf.min.js"></script>

<style>
    body {
        background: #f7f7f7;
        padding: 30px;
    }

    #country-info img {
        width: 160px;
        margin-top: 10px;
    }

    /* ===== Modal personalizado ===== */
    #modal-overlay {
        position: fixed;
        top: 0; left: 0;
        width: 100%; height: 100%;
        background: rgba(0,0,0,0.5);
        display: none;
        justify-content: center;
        align-items: center;
        z-index: 2000;
    }

    #modal {
        background: white;
        padding: 20px;
        border-radius: 10px;
        width: 400px;
    }

    /* ===== GRID CENTRALIZADO ===== */
    .grid-center {
        display: flex;
        flex-wrap: wrap;
        justify-content: center;   /* centraliza */
        gap: 15px;                 /* cards mais pr√≥ximos */
        margin-top: 15px;
    }

    /* ===== CARDS ===== */
    .card {
        width: 250px;              /* tamanho compacto */
        border-radius: 10px;
    }

    .card-img-top {
        height: 110px;
        object-fit: cover;
        border-radius: 10px 10px 0 0;
    }

    .card-body {
        padding: 12px;
    }

    .btn {
        padding: 4px 8px;
        font-size: 14px;
    }
</style>
</head>
<body>

<h1 class="mb-4">Painel de Sele√ß√£o de Pa√≠ses</h1>

<div class="container bg-white p-4 rounded shadow-sm">

    <label class="form-label">Selecione o pa√≠s:</label>
    <input type="text" id="search" class="form-control" placeholder="Digite para filtrar...">

    <select id="country-select" size="8" class="form-select mt-3"></select>

    <div id="country-info" class="mt-3"></div>

    <button id="btn-fav" class="btn btn-primary mt-3" disabled>Favoritar</button>
    <button id="btn-vote" class="btn btn-success mt-3" disabled>Votar</button>
</div>

<hr class="my-5">

<h2>‚≠ê Favoritos</h2>
<div id="favoritesList" class="grid-center"></div>

<hr class="my-5">

<h2>üî• Top 10 Mais Votados</h2>
<div id="rankingList" class="grid-center"></div>

<!-- ======================================
     MODAL
======================================= -->
<div id="modal-overlay">
    <div id="modal">
        <h2 id="modal-title"></h2>
        <div id="modal-content"></div>
        <button class="btn btn-secondary mt-3" onclick="closeModal()">Fechar</button>
    </div>
</div>

<script>
/* ======================================================
   VARI√ÅVEIS
====================================================== */
let countries = [];
let selectedCountry = null;
let currentEditCode = null;

/* ======================================================
   CARREGAR PA√çSES (PRODU√á√ÉO)
====================================================== */
async function loadCountries() {
    try {
        // 1) Carrega o schema .proto
        const root = await protobuf.load("proto/countries.proto");
        const CountryList = root.lookupType("CountryList");

        // 2) Busca o bin√°rio protobuf
        const response = await fetch("http://127.0.0.1:8000/countries?format=protobuf");
        const buffer = await response.arrayBuffer();
        const bytes = new Uint8Array(buffer);

        // 3) Decodifica
        const decoded = CountryList.decode(bytes);

        // 4) Converte para objeto JS normal
        const json = CountryList.toObject(decoded);

        // 5) Mant√©m compatibilidade com o frontend existente
        countries = json.countries;
        fillSelect(countries);

    } catch (err) {
        console.error("Erro ao carregar pa√≠ses (protobuf):", err);
    }
}

function fillSelect(list) {
    const select = document.getElementById("country-select");
    select.innerHTML = "";
    list.forEach(c => {
        const opt = document.createElement("option");
        opt.value = c.code;
        opt.textContent = `${c.name} (${c.code})`;
        select.appendChild(opt);
    });
}

document.getElementById("search").addEventListener("input", (e) => {
    const text = e.target.value.toLowerCase();
    const filtered = countries.filter(c => c.name.toLowerCase().includes(text));
    fillSelect(filtered);
});

document.getElementById("country-select").addEventListener("change", (e) => {
    const code = e.target.value;
    selectedCountry = countries.find(c => c.code === code);

    document.getElementById("country-info").innerHTML = `
        <h3>${selectedCountry.name}</h3>
        <img src="${selectedCountry.flag}">
    `;

    document.getElementById("btn-fav").disabled = false;
    document.getElementById("btn-vote").disabled = false;
});

/* ======================================================
   MODAL
====================================================== */
function openModal(title, html) {
    document.getElementById("modal-title").innerText = title;
    document.getElementById("modal-content").innerHTML = html;
    document.getElementById("modal-overlay").style.display = "flex";
}

function closeModal() {
    document.getElementById("modal-overlay").style.display = "none";
}

/* ======================================================
   FAVORITAR
====================================================== */
document.getElementById("btn-fav").addEventListener("click", () => {
    if (!selectedCountry) return;

    openModal("Adicionar aos Favoritos", `
        <p><strong>${selectedCountry.name}</strong></p>
        <img src="${selectedCountry.flag}" width="140">
        <br><br>
        <textarea id="comment" class="form-control" placeholder="Digite um coment√°rio"></textarea>
        <button class="btn btn-primary w-100 mt-3" onclick="sendFavorite()">Salvar</button>
    `);
});

async function sendFavorite() {
    const comment = document.getElementById("comment").value;

    try {
        const response = await fetch("http://127.0.0.1:8000/favorites", {
            method: "POST",
            headers: {"Content-Type": "application/json"},
            body: JSON.stringify({
                code: selectedCountry.code,
                comment: comment
            })
        });

        // ------ Verificar erro retornado pelo backend ------
        if (!response.ok) {
            const data = await response.json();
            const errorMsg = data.error || "Erro desconhecido";

            // Mostra mensagem de erro dentro do modal
            document.getElementById("modal-content").insertAdjacentHTML(
                "afterbegin",
                `<div class="alert alert-danger">${errorMsg}</div>`
            );
            return;
        }

        // Sucesso
        closeModal();
        loadFavorites();

    } catch (err) {
        // Erro de rede ou backend offline
        document.getElementById("modal-content").insertAdjacentHTML(
            "afterbegin",
            `<div class="alert alert-danger">Falha ao comunicar com o servidor.</div>`
        );
    }
}

/* ======================================================
   VOTAR
====================================================== */
document.getElementById("btn-vote").addEventListener("click", () => {
    openModal("Confirmar Voto", `
        <p><strong>${selectedCountry.name}</strong></p>
        <img src="${selectedCountry.flag}" width="140">
        <br><br>
        <button class="btn btn-success w-100" onclick="sendVote()">Confirmar voto</button>
    `);
});

async function sendVote() {
    await fetch(`http://127.0.0.1:8000/votes/${selectedCountry.code}`, { method: "POST" });
    closeModal();
    loadRanking();
}

/* ======================================================
   LISTAR FAVORITOS
====================================================== */
async function loadFavorites() {
    const res = await fetch("http://127.0.0.1:8000/favorites?format=json");
    const data = await res.json();

    const container = document.getElementById("favoritesList");
    container.innerHTML = "";

    data.favorites.forEach(fav => {
        container.innerHTML += `
            <div class="card shadow-sm">
                <img src="${fav.flag}" class="card-img-top">
                <div class="card-body">
                    <h5>${fav.name} (${fav.code})</h5>
                    <p class="text-muted">${fav.region}</p>
                    <p><strong>Coment√°rio:</strong> ${fav.comment || "<i>Sem coment√°rio</i>"}</p>

                    <button class="btn btn-warning btn-sm" onclick="openEdit('${fav.code}', \`${fav.comment}\`)">Editar</button>
                    <button class="btn btn-danger btn-sm" onclick="deleteFavorite('${fav.code}')">Remover</button>
                </div>
            </div>
        `;
    });
}

/* EDITAR */
function openEdit(code, comment) {
    currentEditCode = code;
    openModal("Editar Coment√°rio", `
        <textarea id="editComment" class="form-control">${comment}</textarea>
        <button class="btn btn-primary w-100 mt-3" onclick="confirmEdit()">Salvar</button>
    `);
}

async function confirmEdit() {
    const newComment = document.getElementById("editComment").value;

    await fetch(`http://127.0.0.1:8000/favorites/${currentEditCode}`, {
        method: "PUT",
        headers: {"Content-Type": "application/json"},
        body: JSON.stringify({ comment: newComment })
    });

    closeModal();
    loadFavorites();
}

/* REMOVER */
async function deleteFavorite(code) {
    await fetch(`http://127.0.0.1:8000/favorites/${code}`, { method: "DELETE" });
    loadFavorites();
}

/* ======================================================
   RANKING
====================================================== */
async function loadRanking() {
    const res = await fetch("http://127.0.0.1:8000/votes/ranking?limit=10");
    const data = await res.json();

    const container = document.getElementById("rankingList");
    container.innerHTML = "";

    data.ranking.forEach(item => {
        container.innerHTML += `
            <div class="card shadow-sm">
                <img src="${item.flag}" class="card-img-top">
                <div class="card-body text-center">
                    <h5>${item.name} (${item.code})</h5>
                    <span class="badge bg-primary">‚≠ê ${item.votes} votos</span>
                </div>
            </div>
        `;
    });
}

/* ======================================================
   INICIALIZA√á√ÉO
====================================================== */
loadCountries();
loadFavorites();
loadRanking();

</script>

</body>
</html>